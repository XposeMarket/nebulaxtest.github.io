<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <title>NEBULAX â€¢ Trending</title>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
<script src="nx-theme.js"></script>
<script> window.NX_BIRDEYE_KEY = '267367afba5b44f2b7398e53aba49f5f'; </script>
<script>window.NX_USE_BIRDEYE_ONLY = true;</script>

    <style>
      :root{
        --nx-cyan:#00e6ff;
        --nx-dark:#0a0d1b;
        --nx-dark-2:#12152a;
        --nx-border:#1e2747;
        --nx-text:#e0e7ff;
        --page-max: 1400px; /* match other pages */
      }
      html,body{height:100%; background:var(--nx-dark); font-family:'Orbitron','ui-monospace','SFMono-Regular',monospace; color:var(--nx-text);}
      .page-wrap{max-width:var(--page-max); margin:18px auto; padding:0 12px;}

      /* Panels */
      .nx-panel{
        background:rgba(16,20,40,.92);
        border:1px solid var(--nx-border);
        box-shadow: inset 0 0 10px rgba(0,230,255,.18), 0 0 12px rgba(0,230,255,.08);
        backdrop-filter: blur(8px);
        border-radius: 16px;
      }
      .nx-title{color:#ffeb3b;text-shadow:0 0 3px #ffeb3b;}
      .tabnums{font-variant-numeric: tabular-nums;}

      /* Buttons */
      .nx-btn{
        border-radius:14px; padding:.42rem .72rem; font-weight:700;
        transition:transform .05s ease, opacity .18s ease, box-shadow .18s ease;
        border:1px solid var(--nx-border); background:var(--nx-dark-2); color:var(--nx-text);
      }
      .nx-btn:hover{opacity:.95}
      .nx-btn:active{transform:translateY(1px)}
      .nx-btn-cyan{ background:var(--nx-cyan); color:#0b101b; border-color:#0d3540; box-shadow:0 0 10px rgba(0,230,255,.3); }

      /* Inputs */
      .nx-input{
        width:100%; border-radius:12px; border:1px solid var(--nx-border);
        background:var(--nx-dark-2); color:var(--nx-text); padding:.55rem .7rem; outline:none;
      }
      .nx-input:focus{border-color:var(--nx-cyan); box-shadow:0 0 0 2px rgba(0,230,255,.14)}

      /* Scrollbar */
      ::-webkit-scrollbar{width:10px;height:10px}
      ::-webkit-scrollbar-track{background:var(--nx-dark-2);border:1px solid #1b2450;border-radius:6px;box-shadow:inset 0 0 8px rgba(0,230,255,.12)}
      ::-webkit-scrollbar-thumb{border-radius:6px;background:var(--nx-cyan);box-shadow:0 0 8px rgba(0,230,255,.35);border:2px solid var(--nx-dark-2)}
      ::-webkit-scrollbar-thumb:hover{background:#6ff3ff}
      *{scrollbar-width:thin; scrollbar-color: var(--nx-cyan) var(--nx-dark-2)}

      /* Popovers / Modals */
      .popover{position:absolute; z-index:1000; border:1px solid var(--nx-border); background:rgba(13,16,34,.98); box-shadow:0 10px 30px rgba(0,0,0,.4); border-radius:12px;}
      .modal-fx{ position:fixed; inset:0; display:none; place-items:center; z-index:2100; background:rgba(0,0,0,.55); padding:12px; }

      /* SEARCH dropdown (homepage/coin style) */
      #search-wrap:focus-within .nx-input{ border-color:var(--nx-cyan); box-shadow:0 0 0 2px rgba(0,230,255,.14); }
      .search-row{ display:flex; align-items:center; gap:.75rem; padding:.45rem .6rem; border-radius:10px; }
      .search-row:hover{ background: var(--nx-dark-2); }
      .search-icon{ height:2rem; width:2rem; display:flex; align-items:center; justify-content:center; border-radius:8px; background:var(--nx-dark-2); }
      .search-grid{ display:grid; grid-template-columns: 1fr auto auto auto; gap:.75rem; align-items:center; min-width:0; }
      .search-name{ min-width:0; }
      .search-name .ticker{ font-size:11px; color:#8b97c9; }
      .search-metric{ font-size:11px; color:#9fb3ff; white-space:nowrap; }
      .search-active{ outline:2px solid var(--nx-cyan); outline-offset:2px; }

      /* Table */
      .nx-table{ width:100%; border-collapse:separate; border-spacing:0; }
      .nx-th, .nx-td{ padding:10px 10px; text-align:left; border-bottom:0; }
      thead .nx-th{
        position:sticky; top:0; z-index:20; user-select:none;
        background:rgba(32,36,64,.95); color:#ffeb3b; text-shadow:0 0 3px #ffeb3b; border-bottom:1px solid var(--nx-border);
      }
      tbody tr{ position:relative; }
      tbody tr::after{
        content:""; position:absolute; left:0; right:0; bottom:0; height:1px; background:#333a66; pointer-events:none;
      }
      tbody tr:hover{ background:rgba(10,14,28,.6); box-shadow: inset 0 0 0 1px rgba(0,230,255,.08); }

      .pill{ display:inline-block; padding:2px 8px; border-radius:999px; font-size:11px; }
      .pill.green{ background:rgba(16,185,129,.18); color:#34d399; }
      .pill.red{ background:rgba(239,68,68,.18); color:#f87171; }

      /* Small row buttons (match NewPairs) */
      .mini-btn{ padding:.38rem .6rem; border:1px solid var(--nx-border); border-radius:12px; background:var(--nx-dark-2); color:#fff; font-weight:700; }
      .mini-btn.alert{ background:#FF1493; border-color:#7a1b5a; }
      .star-btn{ padding:.38rem .6rem; border:1px solid var(--nx-border); border-radius:12px; background:var(--nx-dark-2); color:#fff; font-weight:700; }
      .star-btn.active{ background:#ffd54a; color:#000; border-color:#a37c00; }
    </style>
<style>
  :root {
    --nx-cyan:#00e6ff; --nx-dark:#0a0d1b; --nx-dark-2:#12152a;
    --nx-border:#1e2747; --nx-text:#e0e7ff;
  }
  html[data-theme="amber"]{ --nx-cyan:#ffb020; --nx-dark:#0b0b14; --nx-dark-2:#15162a; --nx-border:#2a2647; --nx-text:#ffeccc; }
  html[data-theme="violet"]{ --nx-cyan:#b69cff; --nx-dark:#0a0a16; --nx-dark-2:#131329; --nx-border:#27224a; --nx-text:#eae4ff; }
  html[data-theme="neon"]{ --nx-cyan:#55ffda; --nx-dark:#070b12; --nx-dark-2:#0d1220; --nx-border:#1a243a; --nx-text:#dbfff7; }

  .nx-tab { padding:.4rem .6rem; border-radius:.7rem; border:1px solid transparent; font-size:.85rem; }
  .nx-tab.active { border-color:var(--nx-border); background:rgba(255,255,255,.03); color:var(--nx-cyan); }
  .nx-btn { font-size:.8rem; padding:.35rem .6rem; border-radius:.6rem; border:1px solid var(--nx-border); }
  .nx-btn-outline { font-size:.8rem; padding:.35rem .6rem; border-radius:.6rem; border:1px dashed var(--nx-border); background:transparent; }
  input::placeholder { color: #7a86a8; }
</style>
  </head>
 

 <body>
    <!-- Header -->
    <header class="sticky top-0 z-[1000] isolate border-b border-[var(--nx-border)] bg-[rgba(10,13,27,0.9)] backdrop-blur-sm">
      <div class="page-wrap h-7 px-1 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <a href="NebulaX.html" class="flex items-center gap-2">
            <img src="NebulaX-logo.png" class="h-6 w-6 rounded-md" alt="NebulaX"/>
            <span class="font-bold tracking-wide" style="text-shadow:0 0 2px var(--nx-cyan);">NEBULAX</span>
          </a>
          <nav class="hidden sm:flex items-center gap-2 ml-2">
            <a class="nx-btn px-2 py-1 text-xs" href="NebulaX.html">Home</a>
            <a class="nx-btn px-2 py-1 text-xs" href="NewPairs-official.html">New Pairs</a>
            <a class="nx-btn px-2 py-1 text-xs" href="Trending.html">Trending</a>
            <a class="nx-btn px-2 py-1 text-xs" href="portfolio_official_v_2_fixed.html">Portfolio</a>
            <a class="nx-btn px-2 py-1 text-xs" href="Adrenaline-official.html">Adrenaline</a>
            <a class="nx-btn px-2 py-1 text-xs" href="nebula_x_store_official.html">Store</a>
          </nav>
        </div>

        <!-- SEARCH -->
        <div id="search-wrap" class="relative w-[26rem] max-w-[60vw]">
          <input id="search-input" class="nx-input" placeholder="Search markets... /" autocomplete="off"/>
          <div id="search-dd" class="popover hidden mt-1 w-full max-h-[22rem] overflow-auto p-2"></div>
        </div>

        <!-- Wallet -->
        <div class="flex items-center gap-2">
          <button id="wallet-btn" class="nx-btn"><i data-lucide="wallet" class="w-3 h-3 mr-2"></i> Bal: 0.214 SOL</button>
        </div>
      <!-- Profile picture -->
      <button id="nx-profile" class="relative w-8 h-8 rounded-xl overflow-hidden border"
              style="border-color:var(--nx-border)">
        <img id="nx-pfp" src="/pfp/default.png" alt="" class="absolute inset-0 w-full h-full object-cover" />
      </button>
    </div>
  </div>
<div class="flex items-center gap-2">
  <select id="nx-theme-picker" class="nx-input w-[9.5rem] text-xs">
    <option value="default">default</option>
    <option value="neon">Neon</option>
    <option value="midnight">Midnight</option>
    <option value="dusk">Dusk</option>
    <option value="light">Light</option>
  </select>
</div>

<script>
  // Wire the picker to the engine
  (function(){
    const sel = document.getElementById('nx-theme-picker');
    if(!sel) return;
    const setSel = () => { try { sel.value = (window.NX?.theme?.get?.() || 'neon'); } catch{} };
    setSel();
    sel.addEventListener('change', () => window.NX?.theme?.set?.(sel.value));
    // keep dropdown in sync if changed on another tab/page
    window.addEventListener('nebula:theme-applied', setSel);
  })();
</script>

</header>

    <div class="page-wrap">
      <!-- Main grid (left table + right widgets) -->
      <main class="mt-3 grid grid-cols-1 lg:grid-cols-[1fr_360px] gap-3">
        <!-- LEFT PANEL -->
        <section class="nx-panel p-3">
          <div class="flex items-center justify-between mb-2">
            <div>
              <div class="text-xl nx-title">Trending Coins</div>
              <div class="text-xs text-zinc-400">Currently most active tokens by volume & hype.</div>
            </div>
          </div>

          <!-- Table -->
          <div class="themed-scroll max-h-[520px] overflow-auto rounded-[12px] border border-[var(--nx-border)]">
            <table class="nx-table" id="trend-table">
              <thead>
                <tr>
                  <th class="nx-th" style="width:220px;">Pair</th>
                  <th class="nx-th">24h Change</th>
                  <th class="nx-th">MC</th>
                  <th class="nx-th">Vol</th>
                  <th class="nx-th">Holders</th>
                  <th class="nx-th" style="width:190px;">Actions</th>
                </tr>
              </thead>
              <tbody id="trend-body"></tbody>
            </table>
          </div>
        </section>

        <!-- RIGHT PANEL (widgets) -->
        <aside class="nx-panel p-3">
          <!-- Watchlist -->
          <div class="nx-panel p-3 mb-3">
            <div class="text-sm font-semibold mb-2">Watchlist</div>
            <div class="flex gap-2 mb-2">
              <button id="btn-clear-watchlist" class="nx-btn">Remove from Watchlist</button>
            </div>
            <div id="watchlist"><div class="text-zinc-400 text-xs">No pairs saved yet.</div></div>
          </div>

          <!-- Alerts Preview -->
          <div class="nx-panel p-3 mb-3">
            <div class="text-sm font-semibold mb-2">Alerts Preview</div>
            <div class="flex gap-2 mb-2">
              <button id="btn-clear-alerts" class="nx-btn">Clear All Alerts</button>
            </div>
            <div id="alerts-mini"><div class="text-zinc-400 text-xs">No triggers yet.</div></div>
          </div>

          <!-- Feed Status -->
          <div class="nx-panel p-3">
            <div class="text-sm font-semibold mb-2">Feed Status</div>
            <div class="text-sm">Status: <span class="text-emerald-400">Connected (mock)</span></div>
            <div class="text-sm">Latency: 38 ms</div>
          </div>
        </aside>
      </main>

      <footer class="mt-3 mb-4">
        <div class="nx-panel px-3 py-2 text-xs flex items-center justify-between">
          <div class="flex items-center gap-3">
            <span class="text-zinc-400">Status:</span>
            <span class="text-emerald-400">Idle (mock)</span>
          </div>
          <div>&copy; <span id="year"></span> NebulaX â€¢ Trending â€¢ Front-end mock</div>
        </div>
      </footer>
    </div>

    <!-- Alerts Modal (per-coin rules) -->
    <div id="alertsModal" class="popover hidden fixed right-4 top-16 w-80 p-3">
      <div class="flex items-center justify-between mb-2">
        <div class="text-sm font-semibold">ENABLE ALERTS</div>
        <button id="alert-cancel" class="nx-btn nx-btn-cyan px-2 py-1 text-xs">Close</button>
      </div>
      <div class="space-y-2 text-sm">
        <label class="flex items-center justify-between px-2 py-1 rounded-md hover:bg-[var(--nx-dark-2)]">
          <span>Whale buy</span><input type="checkbox" value="whale_buy">
        </label>
        <label class="flex items-center justify-between px-2 py-1 rounded-md hover:bg-[var(--nx-dark-2)]">
          <span>Whale sell</span><input type="checkbox" value="whale_sell">
        </label>
        <label class="flex items-center justify-between px-2 py-1 rounded-md hover:bg-[var(--nx-dark-2)]">
          <span>Volume +</span><input type="checkbox" value="volume_spike">
        </label>
        <label class="flex items-center justify-between px-2 py-1 rounded-md hover:bg-[var(--nx-dark-2)]">
          <span>Buys &gt; Sells</span><input type="checkbox" value="buys_sells_ratio">
        </label>
        <label class="flex items-center justify-between px-2 py-1 rounded-md hover:bg-[var(--nx-dark-2)]">
          <span>Holders +</span><input type="checkbox" value="holders_delta">
        </label>
        <label class="flex items-center justify-between px-2 py-1 rounded-md hover:bg-[var(--nx-dark-2)]">
          <span>LP change</span><input type="checkbox" value="lp_change">
        </label>
      </div>
      <button id="alert-save" class="nx-btn nx-btn-cyan w-full mt-3">Save</button>
    </div>

    <!-- Wallet dropdown -->
    <div id="wallet-dd" class="hidden fixed z-[2000] top-16 right-3 w-80 popover p-3">
      <div class="text-sm font-semibold mb-1">Wallet <span class="text-[10px] text-zinc-400">mock</span></div>
      <div class="grid grid-cols-2 gap-2 text-sm mb-2">
        <div class="nx-panel p-2">Total<br/><strong>0.314 SOL</strong></div>
        <div class="nx-panel p-2">Available<br/><strong>0.214 SOL</strong></div>
      </div>
      <div class="grid grid-cols-2 gap-2">
        <button id="wd-open" class="nx-btn">Withdraw</button>
        <button id="dp-open" class="nx-btn nx-btn-cyan">Deposit</button>
      </div>
    </div>

    <!-- Deposit / Withdraw modals -->
    <div id="deposit" class="modal-fx">
      <div class="nx-panel w-[360px] max-w-[90vw] p-3">
        <div class="flex items-center justify-between mb-2"><div class="font-semibold">Deposit</div><button class="nx-btn nx-btn-cyan px-2 py-1 text-xs" data-close="#deposit">Close</button></div>
        <div class="text-sm text-zinc-400 mb-2">Only deposit SOL to this address (mock):</div>
        <div class="nx-panel p-2 text-xs break-words">Do7AJiNrJvFVGTUCw8XvVhRGVBVLTHcBvEnfi3K68gze</div>
        <button class="nx-btn nx-btn-cyan w-full mt-3" onclick="navigator.clipboard.writeText('Do7AJiNrJvFVGTUCw8XvVhRGVBVLTHcBvEnfi3K68gze');alert('Copied! (mock)')">Copy Address</button>
      </div>
    </div>
    <div id="withdraw" class="modal-fx">
      <div class="nx-panel w-[360px] max-w-[90vw] p-3">
        <div class="flex items-center justify-between mb-2"><div class="font-semibold">Withdraw</div><button class="nx-btn nx-btn-cyan px-2 py-1 text-xs" data-close="#withdraw">Close</button></div>
        <div class="space-y-2">
          <input class="nx-input" placeholder="Destination SOL address"/>
          <div class="grid grid-cols-3 gap-2">
            <input class="nx-input col-span-2" placeholder="Amount"/>
            <select class="nx-input">
              <option>SOL</option><option>USD</option>
            </select>
          </div>
          <button class="nx-btn nx-btn-cyan w-full">Submit (mock)</button>
        </div>
      </div>
    </div>

    <script>
      /* Icons + Year */
      if (window.lucide && typeof window.lucide.createIcons==='function'){ window.lucide.createIcons(); }
      document.getElementById('year').textContent = new Date().getFullYear();

      /* Back */
      document.getElementById('back-btn')?.addEventListener('click', (e)=>{ e.preventDefault(); history.back(); });

      /* ===== SEARCH (same as other pages) ===== */
      const SEARCH_DATA = [
        {icon:'â—Ž', name:'SOL / USDC', ticker:'SOL',  mc:'$13.2B', v:'$980M', l:'$120M'},
        {icon:'â—ˆ', name:'WIF / SOL',  ticker:'WIF',  mc:'$4.2B',  v:'$120M', l:'$32M'},
        {icon:'â—ˆ', name:'BONK / SOL', ticker:'BONK', mc:'$1.8B',  v:'$88M',  l:'$20M'},
      ];
      const sWrap=document.getElementById('search-wrap');
      const sIn=document.getElementById('search-input');
      const sDD=document.getElementById('search-dd');
      let activeIndex=-1, currentHits=[];
      const debounce=(fn,ms=150)=>{ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms); }; };

      function renderSearch(q){
        const query=(q||'').trim().toLowerCase();
        currentHits = query? SEARCH_DATA.filter(o => (o.name+o.ticker).toLowerCase().includes(query)) : [];
        sDD.innerHTML=''; activeIndex=-1;
        if(!currentHits.length){ sDD.classList.add('hidden'); return; }
        sDD.classList.remove('hidden');
        sDD.insertAdjacentHTML('beforeend','<div class="px-3 py-2 text-[11px] uppercase tracking-wide text-zinc-400 border-b border-[var(--nx-border)]">Results</div>');
        currentHits.forEach((o,i)=>{
          const row=document.createElement('button');
          row.type='button'; row.className='search-row w-full'; row.dataset.index=i;
          row.innerHTML=`
            <div class="search-icon">${o.icon}</div>
            <div class="search-grid min-w-0 flex-1">
              <div class="search-name min-w-0">
                <div class="truncate">${o.name}</div>
                <div class="ticker">${o.ticker}</div>
              </div>
              <div class="search-metric tabnums">MC <span class="font-semibold">${o.mc}</span></div>
              <div class="search-metric tabnums">V <span class="font-semibold">${o.v}</span></div>
              <div class="search-metric tabnums">L <span class="font-semibold">${o.l}</span></div>
            </div>`;
          row.addEventListener('click',()=>selectHit(i));
          sDD.appendChild(row);
        });
      }
      const doRender = debounce(()=>renderSearch(sIn.value),120);
      sIn.addEventListener('input', doRender);
      sIn.addEventListener('focus', doRender);
      document.addEventListener('click', (e)=>{ if(!sWrap.contains(e.target)) sDD.classList.add('hidden'); });
      sIn.addEventListener('keydown',(e)=>{
        if(sDD.classList.contains('hidden')) return;
        const rows=[...sDD.querySelectorAll('.search-row')]; if(!rows.length) return;
        if(e.key==='ArrowDown'){ e.preventDefault(); rows.forEach(r=>r.classList.remove('search-active')); activeIndex=(activeIndex+1)%rows.length; rows[activeIndex].classList.add('search-active'); rows[activeIndex].scrollIntoView({block:'nearest'}); }
        else if(e.key==='ArrowUp'){ e.preventDefault(); rows.forEach(r=>r.classList.remove('search-active')); activeIndex=(activeIndex-1+rows.length)%rows.length; rows[activeIndex].classList.add('search-active'); rows[activeIndex].scrollIntoView({block:'nearest'}); }
        else if(e.key==='Enter'){ e.preventDefault(); if(activeIndex<0) activeIndex=0; selectHit(activeIndex); }
        else if(e.key==='Escape'){ sDD.classList.add('hidden'); }
      });
function selectHit(i){
  const hit = currentHits[i]; if(!hit) return;
  sDD.classList.add('hidden'); sDD.innerHTML=''; activeIndex=-1; currentHits=[];
  sIn.value='';
  const pair = hit.name.replace(/\s+/g,'');   // "WIF/SOL"
  NX.goToCoin({ pair, mint: hit.mint || '' });
}

      /* ===== Wallet dropdown + modals ===== */
      const wBtn=document.getElementById('wallet-btn'); const wDD=document.getElementById('wallet-dd');
      wBtn?.addEventListener('click',(e)=>{ e.stopPropagation(); wDD.classList.toggle('hidden'); });
      document.addEventListener('click',(e)=>{ if(!wDD?.classList.contains('hidden') && !wDD.contains(e.target) && !wBtn.contains(e.target)) wDD.classList.add('hidden'); });
      document.getElementById('dp-open')?.addEventListener('click',()=>{ wDD.classList.add('hidden'); document.getElementById('deposit').style.display='grid'; });
      document.getElementById('wd-open')?.addEventListener('click',()=>{ wDD.classList.add('hidden'); document.getElementById('withdraw').style.display='grid'; });
      document.querySelectorAll('[data-close]').forEach(btn=>btn.addEventListener('click',()=>{ const id=btn.getAttribute('data-close'); document.querySelector(id).style.display='none'; }));
      ;['deposit','withdraw'].forEach(id=>{ const el=document.getElementById(id); el?.addEventListener('click',(e)=>{ if(e.target===el) el.style.display='none'; }); });

      /* ===== Trending static dataset (mock) ===== */
      const TRENDING = [
        'WIF/SOL','BONK/SOL','MEW/SOL','POPCAT/SOL','BOME/SOL','GME/SOL','PENGU/SOL','CAT/SOL','MOG/SOL'
      ];
      function rnd(a,b){return Math.random()*(b-a)+a;}
      function fmtUSD(n){
        if(n>=1_000_000_000) return '$'+(n/1_000_000_000).toFixed(2)+'B';
        if(n>=1_000_000) return '$'+(n/1_000_000).toFixed(2)+'M';
        if(n>=1_000) return '$'+(n/1_000).toFixed(2)+'K';
        return '$'+n.toString();
      }

      // State: per-coin alerts & watchlist
      const alertsForPair = {}; // { 'BONK/SOL': Set([...]) }
      const watchlistSet = new Set();

      function rowHTML(sym){
        const chg=(rnd(-15,25)).toFixed(2);
        const mc=Math.floor(rnd(5e6,5e8));
        const vol=Math.floor(rnd(1e6,9e7));
        const holders=Math.floor(rnd(100,15000));
        const pill=chg>=0?`<span class="pill green">+${chg}%</span>`:`<span class="pill red">${chg}%</span>`;
        const starred = watchlistSet.has(sym) ? 'active' : '';
        return `
          <tr data-pair="${sym}" data-mc="${mc}">
            <td class="nx-td font-semibold">${sym}</td>
            <td class="nx-td">${pill}</td>
            <td class="nx-td">${fmtUSD(mc)}</td>
            <td class="nx-td">${fmtUSD(vol)}</td>
            <td class="nx-td tabnums">${holders.toLocaleString()}</td>
            <td class="nx-td" style="display:flex; gap:6px;">
              <button class="mini-btn alert" data-act="alert">Alert</button>
              <button class="star-btn ${starred}" data-act="star">â˜…</button>
            </td>
          </tr>`;
      }


      function renderTable(){
        const body=document.getElementById('trend-body');
        body.innerHTML = TRENDING.map(rowHTML).join('');
      }
document.getElementById('trend-body').addEventListener('click', (e)=>{
  const tr = e.target.closest('tr[data-pair]');
  if(!tr) return;
  const pair = tr.getAttribute('data-pair');
  const btn = e.target.closest('button');
  if(btn){
    // existing alert/star logic stays
    const act = btn.getAttribute('data-act');
    if(act === 'alert'){ openAlertModal(pair); return; }
    if(act === 'star'){ /* existing toggle */ return; }
    if(act === 'copy'){ /* existing copy */ return; }
    return; // buttons handled
  }
  // Row click â†’ coin page
  NX.goToCoin({ pair });
});

      // Watchlist rendering
      function redrawWatchlist(){
        const box = document.getElementById('watchlist');
        box.innerHTML = '';
        if(watchlistSet.size===0){
          const empty = document.createElement('div');
          empty.className='text-zinc-400 text-xs';
          empty.textContent = 'No pairs saved yet.';
          box.appendChild(empty);
          return;
        }
        Array.from(watchlistSet).slice(0,20).forEach(p=>{
          const tr = document.querySelector(`tr[data-pair="${CSS.escape(p)}"]`);
          const mc = tr ? tr.getAttribute('data-mc') : null;
          const line = document.createElement('div');
          line.className='text-sm py-1 border-b border-[var(--nx-border)] cursor-pointer hover:bg-[rgba(0,230,255,.08)]';
          line.setAttribute('data-pair', p);
          line.innerHTML = `<strong>${p}</strong> â€¢ ${mc ? fmtUSD(+mc) : 'â€”'} MC`;
          box.appendChild(line);
        });
      }

      // Alerts preview add
      function pushAlertPreview(pair, rules){
        const mini = document.getElementById('alerts-mini');
        const row = document.createElement('div');
        row.className='text-sm py-1 border-b border-[var(--nx-border)] cursor-pointer hover:bg-[rgba(0,230,255,.08)]';
        row.setAttribute('data-pair', pair);
        row.textContent = `${pair}: ${rules.length?rules.join(', '):'No rules selected'} (saved mock)`;
        mini.prepend(row);
        while(mini.children.length>12) mini.removeChild(mini.lastChild);
      }

      // Table action handlers
      document.getElementById('trend-body').addEventListener('click', (e)=>{
        const tr = e.target.closest('tr[data-pair]');
        if(!tr) return;
        const pair = tr.getAttribute('data-pair');
        const btn = e.target.closest('button');

        if(btn){
          const act = btn.getAttribute('data-act');
          if(act === 'alert'){ openAlertModal(pair); return; }
          if(act === 'star'){
            if(watchlistSet.has(pair)){ watchlistSet.delete(pair); } else { watchlistSet.add(pair); }
            btn.classList.toggle('active', watchlistSet.has(pair));
            redrawWatchlist();
            return;
          }
        }
        // Row click (navigate mock)
      });

      document.getElementById('watchlist').addEventListener('click', (e)=>{
        const el = e.target.closest('[data-pair]'); if(!el) return;
        alert(`Navigate to ${el.getAttribute('data-pair')} (mock)`);
      });

      document.getElementById('btn-clear-watchlist').addEventListener('click', ()=>{
        if(watchlistSet.size===0) return;
        const watched = new Set(watchlistSet);
        watchlistSet.clear();
        watched.forEach(pair=>{
          const rowBtn = document.querySelector(`tr[data-pair="${CSS.escape(pair)}"] [data-act="star"]`);
          rowBtn?.classList.remove('active');
        });
        redrawWatchlist();
      });

      // Alerts modal (same as NewPairs)
      let currentAlertPair = null;
      const modal = document.getElementById('alertsModal');
      function openAlertModal(pair){
        currentAlertPair = pair;
        modal.classList.remove('hidden');
        modal.querySelectorAll('input[type="checkbox"]').forEach(c => {
          const saved = alertsForPair[pair] || new Set();
          c.checked = saved.has(c.value);
        });
      }
      document.getElementById('alert-cancel').onclick = ()=>{ modal.classList.add('hidden'); };
      document.getElementById('alert-save').onclick = ()=>{
        const checks = [...modal.querySelectorAll('input[type="checkbox"]')].filter(c=>c.checked).map(c=>c.value);
        alertsForPair[currentAlertPair] = new Set(checks);
        modal.classList.add('hidden');
        pushAlertPreview(currentAlertPair, checks);
      };
      document.getElementById('alerts-mini').addEventListener('click', (e)=>{
        const el = e.target.closest('[data-pair]'); if(!el) return;
        alert(`Navigate to ${el.getAttribute('data-pair')} (mock)`);
      });
      document.getElementById('btn-clear-alerts').addEventListener('click', ()=>{
        for (const k in alertsForPair) delete alertsForPair[k];
        const mini = document.getElementById('alerts-mini');
        mini.innerHTML = '<div class="text-zinc-400 text-xs">No triggers yet.</div>';
      });
document.addEventListener('click',(e)=>{
  if(!sWrap.contains(e.target)){
    sDD.classList.add('hidden');
    sDD.innerHTML='';
    activeIndex=-1; currentHits=[];
  }
});
sIn.addEventListener('keydown',(e)=>{
  if(e.key==='Escape'){
    sDD.classList.add('hidden'); sDD.innerHTML=''; activeIndex=-1; currentHits=[];
  }
});


      // Initial render
      renderTable();
      redrawWatchlist();
    </script>
<script>
/** ===== NebulaX Click-to-Coin Utilities ===== */
window.NX = window.NX || {};
NX.saveSelectedCoin = function(coin){
  try { localStorage.setItem('nebula_selected_coin', JSON.stringify(coin)); } catch(e){}
};
NX.goToCoin = function(coin){
  NX.saveSelectedCoin(coin);
  const pair = coin.pair || (coin.symbol ? (coin.symbol.toUpperCase()+'/SOL') : '');
  const mint = encodeURIComponent(coin.mint || '');
  const qp = `?pair=${encodeURIComponent(pair)}${mint ? `&mint=${mint}` : ''}`;
  location.href = `Coinpage-Official.html${pair ? qp : ''}`;
};
</script>

<script>
function nxOpenCoin({ pair, mint = '' }) {
  const url = `Coinpage-Official.html?pair=${encodeURIComponent(pair)}&mint=${encodeURIComponent(mint)}`;
  location.href = url;
}
</script>
<script>
document.querySelectorAll('.row-card[data-symbol]').forEach(row=>{
  row.addEventListener('click', (e)=>{
    // Allow inner buttons (copy, alert, star) to work without navigating
    if (e.target.closest('button, .copy-btn')) return;
    const sym = row.dataset.symbol.trim().toUpperCase(); // e.g. WIF
    const mint = row.dataset.mint || '';                  // add data-mint="..." if you have it
    nxOpenCoin({ pair: `${sym}/SOL`, mint });
  });
});
</script>

<script>
/* === NebulaX Core (themes, header hydrate, routing hooks) === */
(function(){
  const UserStore={
    key:'nx_user',
    state:{ wallet:null, theme:'default', pfp:{type:'builtin',url:'/pfp/default.png'} },
    load(){ try{ Object.assign(this.state, JSON.parse(localStorage.getItem(this.key)||'{}')); }catch{} },
    save(){ localStorage.setItem(this.key, JSON.stringify(this.state)); }
  };
  UserStore.load();

  const Theme={
    init(){
      const t = UserStore.state.theme || 'default';
      document.documentElement.setAttribute('data-theme', t);
      const sel = document.getElementById('nx-theme');
      if (sel) sel.value = t;
      sel?.addEventListener('change', (e)=>{
        const v=e.target.value;
        document.documentElement.setAttribute('data-theme', v);
        UserStore.state.theme=v; UserStore.save();
      });
    }
  };

  const Header={
    initActiveTab(){
      const here = location.pathname.replace(/\/+$/,'') || '/NebulaX.html';
      document.querySelectorAll('.nx-tab').forEach(a=>{
        const route = a.getAttribute('data-route');
        if (!route) return;
        if (route===here) a.classList.add('active');
        else a.classList.remove('active');
        a.addEventListener('click',(e)=>{
          // allow normal navigation
        });
      });
    },
    initSearch(){
      const input = document.getElementById('nx-search');
      const btn   = document.getElementById('nx-search-btn');
      if(!input||!btn) return;
      const go = ()=>{
        const q = (input.value||'').trim();
        if(!q) return;
        // Route to coin page convention: /Coinpage-Official.html?query=...
        location.href = `/Coinpage-Official.html?query=${encodeURIComponent(q)}`;
      };
      btn.addEventListener('click', go);
      input.addEventListener('keydown', (e)=>{ if(e.key==='Enter') go(); });
    },
    initPfp(){
      const img = document.getElementById('nx-pfp');
      if(img) img.src = (UserStore.state.pfp?.url)||'/pfp/default.png';
      const btn = document.getElementById('nx-profile');
      btn?.addEventListener('click',()=>{
        // simple MVP: cycle built-ins; later open profile modal
        const choices=['/pfp/default.png','/pfp/nx01.png','/pfp/nx02.png'];
        const idx = Math.max(0, choices.indexOf(UserStore.state.pfp?.url));
        const next = choices[(idx+1)%choices.length];
        UserStore.state.pfp={type:'builtin',url:next}; UserStore.save();
        if(img) img.src=next;
      });
    },
    initStore(){
      const a = document.getElementById('nx-store');
      if(!a) return;
      // keep as a link; if you make a modal later, hydrate here
    },
    initWallet(){
      const w = document.getElementById('nx-wallet');
      w?.addEventListener('click', ()=>{
        // hook your wallet adapter here
        alert('Connect wallet (hook your adapter)');
      });
    },
    mount(){ this.initActiveTab(); this.initSearch(); this.initPfp(); this.initStore(); this.initWallet(); }
  };

  document.addEventListener('DOMContentLoaded', ()=>{
    Theme.init();
    Header.mount();
  });
})();
</script>

<script>
/* ===== NebulaX Trending: live data fill (non-destructive) ===== */
(function(){
  const BIRDEYE_KEY = window.NX_BIRDEYE_KEY || '267367afba5b44f2b7398e53aba49f5f';
  const CHAIN = 'solana';
  const LIMIT = 20;            // how many rows to show
  const CACHE_MS = 60_000;     // cache Birdeye list for 90s
  const PAIR_CACHE_MS = 6*60*60*1000; // mintâ†’pair cache for 6h

  const $ = (sel,root=document)=>root.querySelector(sel);
  const body = document.getElementById('trend-body');
  if(!body) return;

  // simple number formatting to match your UI
  const fmtUSD = (n)=>{
    n = Number(n||0);
    if(n>=1e9) return '$'+(n/1e9).toFixed(2)+'B';
    if(n>=1e6) return '$'+(n/1e6).toFixed(2)+'M';
    if(n>=1e3) return '$'+(n/1e3).toFixed(2)+'K';
    return '$'+(n||0).toFixed?.(2)?.replace(/\.00$/,'') ?? ('$'+n);
  };
  const pill = (pct)=>{
    const v = Number(pct||0);
    const cls = v>=0 ? 'pill green' : 'pill red';
    const sign = v>0 ? '+' : '';
    return `<span class="${cls}">${sign}${v.toFixed(2)}%</span>`;
  };

  // --- caching helpers ---
  const cache = {
    get(k,maxAge){
      try{
        const raw = sessionStorage.getItem(k); if(!raw) return null;
        const {ts,data} = JSON.parse(raw);
        if(Date.now()-ts>maxAge) return null;
        return data;
      }catch{ return null; }
    },
    set(k,data){ try{ sessionStorage.setItem(k, JSON.stringify({ts:Date.now(),data})); }catch{} }
  };

async function birdeyeTrending(limit){
  const key = `nx_trend_list_${limit}`;
  const cached = cache.get(key, CACHE_MS);
  if (cached) return cached;

  // âœ… correct endpoint + headers
// inside birdeyeTrending(limit)
const url = new URL('https://public-api.birdeye.so/defi/token_trending');
url.searchParams.set('limit', String(Math.min(20, (limit|0) || 20)));


  const res = await fetch(url.toString(), {
    headers: {
      'X-API-KEY': BIRDEYE_KEY,
      'accept': 'application/json',
      'x-chain': 'solana'   // <â€” important
    }
  });

  if (!res.ok) {
    const txt = await res.text().catch(()=> '');
    throw new Error(`Birdeye ${res.status} ${txt}`);
  }

  const j = await res.json();
  // Some responses use data.items; others data.markets â€” handle both
// --- Robust extraction: ensure we end up with an ARRAY ---
const data = j?.data ?? [];
let items =
  (Array.isArray(data) && data) ||
  (Array.isArray(data.items) && data.items) ||
  (Array.isArray(data.markets) && data.markets) ||
  (Array.isArray(data.tokens) && data.tokens) ||
  (Array.isArray(data.list) && data.list) ||
  (Array.isArray(data.result) && data.result) ||
  (data && typeof data === 'object' ? Object.values(data) : []);

// Final guard
if (!Array.isArray(items)) items = [];

  // normalize into our row model
  const rows = items.map(it => ({
    mint: it?.address || it?.token_address || it?.mintAddress || it?.mint,
    symbol: (it?.symbol || it?.baseSymbol || it?.token_symbol || '').toUpperCase(),
    name: it?.name || it?.token_name || '',
    priceUsd: it?.price || it?.value || 0,
    change24h: it?.change24h ?? it?.priceChange24h ?? it?.price_change_24h ?? 0,
    volume24h: it?.v24hUsd ?? it?.volume24hUsd ?? it?.v24h ?? it?.volume_24h ?? 0,
    mcap: it?.marketCap ?? it?.market_cap ?? 0,
    pairAddress: it?.pairAddress || it?.poolAddress || null
  })).filter(r => r.mint);

  cache.set(key, rows);
  return rows;
}


  async function dexscreenerBestPairByMint(mint){
    const ck = `nx_pair_${mint}`;
    const c = cache.get(ck, PAIR_CACHE_MS);
    if(c) return c;
    const res = await fetch(`https://api.dexscreener.com/latest/dex/tokens/${mint}`);
    if(!res.ok) return null;
    const j = await res.json();
    const pairs = Array.isArray(j?.pairs) ? j.pairs : [];
    if(!pairs.length) return null;
    pairs.sort((a,b)=> (b?.liquidity?.usd||0) - (a?.liquidity?.usd||0));
    const best = pairs[0]?.pairAddress || null;
    if(best) cache.set(ck, best);
    return best;
  }

  // --- row rendering (matches your existing table classes) ---
  function rowHTML(model){
    const holders = 'â€”'; // (optional) later we can add a holders lookup; keeping UI intact
    const mcap = model.mcap ? fmtUSD(model.mcap) : 'â€”';
    const vol  = fmtUSD(model.volume24h||0);
    const chg  = pill(model.change24h||0);
    // we include mint & pair addr on the row for routing
    const data = [
      `data-pair="${(model.symbol||'')+'/SOL'}"`,
      model.pairAddress ? `data-addr="${model.pairAddress}"` : '',
      `data-mint="${model.mint}"`
    ].filter(Boolean).join(' ');

    return `
      <tr ${data}>
        <td class="nx-td font-semibold">${model.symbol||'â€”'}/SOL</td>
        <td class="nx-td">${chg}</td>
        <td class="nx-td">${mcap}</td>
        <td class="nx-td">${vol}</td>
        <td class="nx-td tabnums">${holders}</td>
        <td class="nx-td" style="display:flex; gap:6px;">
          <button class="mini-btn alert" data-act="alert">Alert</button>
          <button class="star-btn" data-act="star">â˜…</button>
        </td>
      </tr>`;
  }

  // --- fill the table, resolving missing pairs on the fly ---
  async function renderTrending(){
    body.innerHTML = `<tr><td class="nx-td" colspan="6"><span class="text-cyan-300/70 text-sm">Loading trendingâ€¦</span></td></tr>`;

    let rows = await birdeyeTrending(LIMIT);

    // Resolve missing pairAddress concurrently (best-effort)
    const tasks = rows.map(async r=>{
      if(!r.pairAddress){
        try{ r.pairAddress = await dexscreenerBestPairByMint(r.mint); }catch{}
      }
      return r;
    });
    rows = await Promise.all(tasks);

    // Render
    body.innerHTML = rows.map(rowHTML).join('');
    try{ window.lucide?.createIcons?.(); }catch{}
  }
body.setAttribute('data-live-filled', '1');

  // --- high-priority click handler (runs BEFORE the old mock handler) ---
  body.addEventListener('click', (e)=>{
    const tr = e.target.closest('tr[data-mint]'); if(!tr) return;
    // ignore clicks on buttons (alert/star); let your existing handlers run
    if(e.target.closest('button')) return;

    const addr = tr.getAttribute('data-addr')||'';
    const mint = tr.getAttribute('data-mint')||'';
    const pairSym = tr.getAttribute('data-pair')||'';

    // Prefer actual pair address for DexScreener; fall back to symbol if needed
    const params = new URLSearchParams({ chain: CHAIN, mint });
    if(addr) params.set('pair', addr);
    else if(pairSym) params.set('pair', pairSym);

    // Stop any older click handler from hijacking the route
    e.stopImmediatePropagation();
    location.href = `Coinpage-Official.html?${params.toString()}`;
  }, true /* capture */);

  // Go live
  renderTrending();
  // Optional light refresh:
  setInterval(renderTrending, CACHE_MS);
})();
</script>
<script>
(() => {
  // ========= NebulaX Pro-Degen v1 (Starter-friendly) =========
  const BIRDEYE_KEY = window.NX?.BIRDEYE_KEY || localStorage.getItem('BIRDEYE_KEY') || '<PUT_YOUR_KEY>';
  const CHAIN = 'solana';
  const STARTER_MODE = true; // true = prefer single endpoints; set false to try batch everywhere.
  const CANDIDATE_SIZE = 60; // keep small for Starter. Increase when you upgrade.
  const REFRESH_PRICES_MS = 15000; // prices/trades refresh
  const REFRESH_SLOW_MS = 60000;   // MC/liq/holders refresh
  const HEADERS = { 'X-API-KEY': BIRDEYE_KEY, 'x-chain': CHAIN, 'accept': 'application/json' };

  // --- DOM targets (adjust if your IDs differ)
const tableBody =
  document.querySelector('#trend-body') ||
  document.querySelector('#trending-tbody') ||
  document.querySelector('tbody');  const statusEl = ensureStatus();

  // --- Simple cache (sessionStorage) ----------------------------------------
  const SS_KEY = 'nx_trending_cache_v1';
  const cache = JSON.parse(sessionStorage.getItem(SS_KEY) || '{}');
  function saveCache() { sessionStorage.setItem(SS_KEY, JSON.stringify(cache)); }
  function getCached(mint) { return cache[mint]; }
  function setCached(mint, data) { cache[mint] = {...(cache[mint]||{}), ...data, _ts: Date.now()}; }

  // --- Utils ----------------------------------------------------------------
  const sleep = (ms) => new Promise(r => setTimeout(r, ms));
  const clamp = (n, a, b) => Math.max(a, Math.min(b, n));
  function zscores(arr, key) {
    const vals = arr.map(o => Number(o[key] ?? 0));
    const mean = vals.reduce((a,b)=>a+b,0)/Math.max(1,vals.length);
    const sd = Math.sqrt(vals.reduce((a,b)=>a + Math.pow(b-mean,2),0)/Math.max(1,vals.length));
    const denom = sd || 1;
    const map = new Map(arr.map((o,i)=>[o.mint, clamp((vals[i]-mean)/denom, -3, 3)]));
    return (mint) => map.get(mint) || 0;
  }
  function ewma(values, lambda=0.7) {
    // most recent last
    let prev = values[0] || 0;
    for (let i=1;i<values.length;i++) prev = lambda*values[i] + (1-lambda)*prev;
    return prev;
  }
  function nowIso() { return new Date().toISOString(); }
  function minutesAgo(m) { return new Date(Date.now() - m*60000).toISOString(); }

  // --- Fetch helpers ---------------------------------------------------------
  async function jget(url, opts={}) {
    const r = await fetch(url, {headers: HEADERS, ...opts});
    if (!r.ok) throw new Error(`${r.status} ${r.statusText}`);
    const j = await r.json();
    return j?.data ?? j;
  }

  // 1) Candidate pool: Birdeye trending (cheap) OR markets page
  async function fetchCandidates(limit=CANDIDATE_SIZE) {
    // Try Birdeye "token_trending"
    try {
      const d = await jget(`https://public-api.birdeye.so/defi/token_trending?limit=${limit}`);
      // normalize: expect d = array of tokens with .address or .mint
      const rows = (Array.isArray(d)? d : (d?.tokens || d?.items || [])).slice(0,limit);
      const mints = rows.map(x => x.address || x.mint).filter(Boolean);
      if (mints.length) return [...new Set(mints)];
    } catch(e) {
      console.warn('trending fallback->markets', e);
    }
    // Fallback: top markets (page 1)
    const md = await jget(`https://public-api.birdeye.so/defi/v2/markets?sort_by=volume_usd_24h&sort_type=desc&offset=0&limit=${limit}`);
    const mints = (md?.items || md || []).map(x => x.address || x.mint).filter(Boolean);
    return [...new Set(mints)].slice(0, limit);
  }

  // 2) Hydrators (Starter: single endpoints; upgraded: batch) -----------------
  async function hydrateMarketData(mints) {
    const out = {};
    if (!STARTER_MODE) {
      try {
        const chunk = mints.join(',');
        const md = await jget(`https://public-api.birdeye.so/defi/v3/token/market-data/multiple?addresses=${chunk}`);
        Object.entries(md||{}).forEach(([mint, v]) => out[mint] = {
          mcapUsd: v.market_cap ?? null,
          liqUsd: v.liquidity ?? v.liquidity_usd ?? null,
          vol24h: v.v24hUsd ?? v.volume_usd_24h ?? null,
          price: v.price ?? null,
          verified: !!v.verified
        });
        return out;
      } catch(e) { console.warn('market-data multiple not available, single fallback', e); }
    }
    // Single fallback (respect Starter limits: stagger)
    for (const mint of mints) {
      try {
        const v = await jget(`https://public-api.birdeye.so/defi/v3/token/market-data?address=${mint}`);
        out[mint] = {
          mcapUsd: v.market_cap ?? null,
          liqUsd: v.liquidity ?? v.liquidity_usd ?? null,
          vol24h: v.v24hUsd ?? v.volume_usd_24h ?? null,
          price: v.price ?? null,
          verified: !!v.verified
        };
        await sleep(120); // be gentle on 1 rps
      } catch(e) { console.warn('md single fail', mint, e); }
    }
    return out;
  }

  async function hydratePriceStats(mints) {
    const out = {};
    if (!STARTER_MODE) {
      try {
        const ps = await jget(`https://public-api.birdeye.so/defi/v3/price/stats/multiple?addresses=${mints.join(',')}`);
        Object.entries(ps||{}).forEach(([mint, v]) => out[mint] = {
          pct24h: v.price_change_24h ?? null
        });
        return out;
      } catch(e) { console.warn('price-stats multiple not available, single fallback', e); }
    }
    for (const mint of mints) {
      try {
        const v = await jget(`https://public-api.birdeye.so/defi/v3/price/stats?address=${mint}`);
        out[mint] = { pct24h: v.price_change_24h ?? null };
        await sleep(80);
      } catch(e) { console.warn('ps single fail', mint, e); }
    }
    return out;
  }

  // Light OHLCV to derive 5m change + EWMA burst
  async function hydrateOhlcv5m(mints) {
    const out = {};
    // Starter: weâ€™ll request a small window per token (e.g., 30m of 1m candles)
    for (const mint of mints) {
      try {
        const to = nowIso();
        const from = minutesAgo(30);
        const o = await jget(`https://public-api.birdeye.so/defi/ohlcv?address=${mint}&type=1m&time_from=${from}&time_to=${to}`);
        const candles = Array.isArray(o) ? o : (o.items || []);
        // last 6 candles ~ 5-6m
        const last6 = candles.slice(-6);
        const closes = last6.map(c => Number(c.close || c.c || 0));
        const vols = last6.map(c => Number(c.volume || c.v || 0));
        const open5m = last6[0]?.open ?? last6[0]?.o ?? closes[0];
        const last = closes[closes.length-1] || 0;
        const pct5m = (open5m && last) ? ((last-open5m)/open5m)*100 : 0;
        const vol5mEWMA = ewma(vols, 0.7);
        out[mint] = { pct5m, vol5mEWMA };
        await sleep(60);
      } catch(e) { console.warn('ohlcv fail', mint, e); }
    }
    return out;
  }

  // Recent trades snapshot to approximate trades/buyers imbalance
  async function hydrateTrades15m(mints) {
    const out = {};
    for (const mint of mints) {
      try {
        const to = Date.now();
        const from = to - 15*60*1000;
        const tr = await jget(`https://public-api.birdeye.so/defi/txs/token?address=${mint}&time_from=${Math.floor(from/1000)}&time_to=${Math.floor(to/1000)}&page=1&page_size=100`);
        const items = tr?.items || tr || [];
        const buyers = new Set();
        let buys=0, sells=0;
        items.forEach(tx => {
          const side = (tx.side || tx.trade || '').toLowerCase();
          if (side.includes('buy')) { buys++; buyers.add(tx.trader || tx.user || tx.source || ''); }
          else if (side.includes('sell')) { sells++; }
        });
        const trades15m = items.length;
        const uniqBuyers15m = buyers.has('') ? buyers.size-1 : buyers.size;
        const imbalance15m = (buys + sells) ? buys / (buys + sells) : 0.5;
        out[mint] = { trades15m, uniqBuyers15m, imbalance15m };
        await sleep(60);
      } catch(e) { console.warn('trades15m fail', mint, e); }
    }
    return out;
  }

  // Holders (free on Standard Solana). Peek first page and read total.
  async function hydrateHolders(mints) {
    const out = {};
    for (const mint of mints) {
      try {
        const d = await jget(`https://public-api.birdeye.so/defi/v3/token/holder?address=${mint}&page=1&page_size=1`);
        // Try several possible shapes:
        const total = d?.total ?? d?.count ?? d?.pagination?.total ?? null;
        out[mint] = { holders: Number(total || 0) };
        await sleep(80);
      } catch(e) { console.warn('holders fail', mint, e); }
    }
    return out;
  }

  // 3) Score, gates, and compose --------------------------------------------
  const DEFAULT_GATES = {
    minLiq: 25000,
    minTrades15m: 40,
    minBuyers15m: 20,
    maxImpact1k: 0.15, // not used in v1 (needs exit-liquidity), left for future
    minAgeMin: 30
  };

  function computeScore(rows) {
    // Build zscore getters for each metric we have
    const zVol5 = zscores(rows, 'vol5mEWMA');
    const zBuyers = zscores(rows, 'uniqBuyers15m');
    const zImbal = zscores(rows, 'imbalance15m');
    const zPct5 = zscores(rows, 'pct5m');
    const zVol60 = zscores(rows, 'vol24h'); // proxy if no 60m
    const zLiq = zscores(rows, 'liqUsd');
    const zMC = zscores(rows, 'mcapUsd');
    const zH = zscores(rows, 'holders');
    const zT = zscores(rows, 'trades15m');
    const zVolty = zscores(rows, 'volatilityScore'); // optional

    for (const r of rows) {
      const rugRisk = Number(r.rugRiskScore || 0);
      r.score =
        0.28 * zVol5(r.mint) +
        0.16 * zBuyers(r.mint) +
        0.14 * zImbal(r.mint) +
        0.12 * zPct5(r.mint) +
        0.10 * zVol60(r.mint) +
        0.08 * zLiq(r.mint) +
        0.06 * zH(r.mint) +
        0.04 * zT(r.mint) +
        0.02 * zVolty(r.mint) -
        0.06 * rugRisk;
    }
    return rows.sort((a,b)=>b.score - a.score);
  }

  function hardGate(r, gates=DEFAULT_GATES) {
    if ((r.liqUsd ?? 0) < gates.minLiq) return false;
    if ((r.trades15m ?? 0) < gates.minTrades15m) return false;
    if ((r.uniqBuyers15m ?? 0) < gates.minBuyers15m) return false;
    if ((r.ageMin ?? 9999) < gates.minAgeMin) return false;
    if (r.paused) return false;
    if (r.blocked) return false;
    return true;
  }

  // 4) Orchestrator -----------------------------------------------------------
  async function renderProDegen() {
    try {
      status('Loading candidatesâ€¦');
      const mints = await fetchCandidates(CANDIDATE_SIZE);

      // reuse cache to avoid slow calls
      const need = mints.filter(m => {
        const c = getCached(m);
        return !c || (Date.now() - (c._ts||0) > REFRESH_SLOW_MS);
      });

      // Hydrate slow-changing fields
      const [md, ps, o5, tr15, hh] = await sequenceHydrate(need);

      // Merge into cache
      for (const mint of mints) {
        const c = getCached(mint) || {};
        const merged = {
          mint,
          symbol: c.symbol || md?.[mint]?.symbol || c.name || '',
          name: c.name || '',
          price: md?.[mint]?.price ?? c.price ?? null,
          mcapUsd: md?.[mint]?.mcapUsd ?? c.mcapUsd ?? null,
          liqUsd: md?.[mint]?.liqUsd ?? c.liqUsd ?? null,
          vol24h: md?.[mint]?.vol24h ?? c.vol24h ?? null,

          pct24h: ps?.[mint]?.pct24h ?? c.pct24h ?? null,
          pct5m: o5?.[mint]?.pct5m ?? c.pct5m ?? 0,
          vol5mEWMA: o5?.[mint]?.vol5mEWMA ?? c.vol5mEWMA ?? 0,

          trades15m: tr15?.[mint]?.trades15m ?? c.trades15m ?? 0,
          uniqBuyers15m: tr15?.[mint]?.uniqBuyers15m ?? c.uniqBuyers15m ?? 0,
          imbalance15m: clamp(tr15?.[mint]?.imbalance15m ?? c.imbalance15m ?? 0.5, 0.35, 0.75),

          holders: hh?.[mint]?.holders ?? c.holders ?? 0,

          // placeholders for future flags/age (can be hydrated from metadata/RPC)
          ageMin: c.ageMin ?? 60,
          paused: !!c.paused,
          blocked: !!c.blocked,
          verified: md?.[mint]?.verified ?? c.verified ?? false,
        };
        setCached(mint, merged);
      }
      saveCache();

      // Compose rows in table order
      let rows = mints.map(m => getCached(m)).filter(Boolean);

      // Apply hard gates
      rows = rows.filter(r => hardGate(r));

      // Compute (and apply) score
      rows = computeScore(rows);

      // Render
      status(`Showing ${rows.length} tokens Â· updated ${new Date().toLocaleTimeString()}`);
      if (!tableBody) return;
      tableBody.innerHTML = rows.map(rowHTML).join('');
    } catch (e) {
      console.error(e);
      status('Failed to load trending.');
    }
  }

  async function sequenceHydrate(need) {
    if (!need.length) return [{}, {}, {}, {}, {}];
    const md = await hydrateMarketData(need);
    await sleep(100);
    const ps = await hydratePriceStats(need);
    await sleep(100);
    const o5 = await hydrateOhlcv5m(need);
    await sleep(100);
    const tr15 = await hydrateTrades15m(need);
    await sleep(100);
    const hh = await hydrateHolders(need);
    return [md, ps, o5, tr15, hh];
  }

  // 5) Minimal rowHTML fallback (use your own if present) ---------------------
  function rowHTML(r) {
    const n = (x, d=0) => (x||x===0) ? Number(x).toLocaleString(undefined,{maximumFractionDigits:d}) : 'â€”';
    const pc = (x) => (x||x===0) ? `${(x>0?'+':'')}${x.toFixed(2)}%` : 'â€”';
    const liq = n(r.liqUsd, 0);
    const mc = n(r.mcapUsd, 0);
    const vol = n(r.vol24h, 0);
    const h = n(r.holders, 0);
    const p5 = pc(r.pct5m||0);
    const p24 = pc(r.pct24h);
    const score = (r.score ?? 0).toFixed(2);
    const cls5 = (r.pct5m||0) >= 0 ? 'text-emerald-400' : 'text-rose-400';
    const cls24 = (r.pct24h||0) >= 0 ? 'text-emerald-400' : 'text-rose-400';
    return `
      <tr class="border-b border-white/5 hover:bg-white/5 transition">
        <td class="py-2 px-3">
          <div class="flex items-center gap-2">
            <div class="w-2 h-2 rounded-full ${r.verified?'bg-cyan-400':'bg-zinc-500'}"></div>
            <div class="font-semibold">${r.symbol || r.name || r.mint.slice(0,4)+'â€¦'}</div>
            <div class="text-xs opacity-60">${r.mint.slice(0,4)}â€¦${r.mint.slice(-4)}</div>
          </div>
        </td>
        <td class="py-2 px-3 text-right">${n(r.price, 6)}</td>
        <td class="py-2 px-3 text-right ${cls5}">${p5}</td>
        <td class="py-2 px-3 text-right ${cls24}">${p24}</td>
        <td class="py-2 px-3 text-right">${liq}</td>
        <td class="py-2 px-3 text-right">${mc}</td>
        <td class="py-2 px-3 text-right">${vol}</td>
        <td class="py-2 px-3 text-right">${h}</td>
        <td class="py-2 px-3 text-right text-cyan-300 font-bold">${score}</td>
      </tr>
    `;
  }

  // 6) Status helper ----------------------------------------------------------
  function ensureStatus() {
    let el = document.getElementById('trending-status');
    if (!el) {
      el = document.createElement('div');
      el.id = 'trending-status';
      el.className = 'text-xs text-white/60 px-3 py-1';
      (document.querySelector('#trending-head') || document.body).prepend(el);
    }
    return el;
  }
  function status(msg){ try{ statusEl.textContent = msg; }catch{} }

  // 7) Boot + refresh loops ---------------------------------------------------
  let running = false;
  async function tick() {
    if (running) return;
    running = true;
    try { await renderProDegen(); }
    finally { running = false; }
  }
  document.addEventListener('visibilitychange', () => { if (!document.hidden) tick(); });
  tick(); // initial
  setInterval(tick, REFRESH_PRICES_MS); // light refresh
  // slow refresh to refresh MC/liq/holders cache naturally
  setInterval(() => { /* marker to let cache expire naturally */ }, REFRESH_SLOW_MS);

})();
</script>

   
  </body>
</html>













