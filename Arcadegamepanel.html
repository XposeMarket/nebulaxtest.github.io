<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>NEBULAX • Arcade Game</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
<script src="nx-theme.js"></script>
<script src="https://unpkg.com/@solana/web3.js@1.95.3/lib/index.iife.min.js"></script>
<script>
  window.NX_RPC = "https://rpc.helius.xyz/?api-key=3858d764-530d-4b75-b3df-619dc2613ff9";
</script>
<script src="assets/nx-wallet.js"></script>
<script>
document.addEventListener("DOMContentLoaded", async () => {
  const btn = document.getElementById("wallet-btn");
  function paint(sol){
    if (!btn) return;
    if (sol == null) {
      btn.innerHTML = `<i data-lucide="wallet" class="w-3 h-3 mr-2"></i> Connect Wallet`;
    } else {
      const s = sol.toFixed(3);
      btn.innerHTML = `<i data-lucide="wallet" class="w-3 h-3 mr-2"></i> Bal: ${s} SOL`;
    }
    try { window.lucide?.createIcons?.(); } catch {}
  }
  if (window.NXWallet?.isConnected?.()) {
    try { await window.NXWallet.refreshBalance?.(true); } catch {}
    paint(window.NXWallet?.getBalance?.());
  } else {
    const prov = (window.phantom?.solana) || window.solana;
    try { await prov?.connect?.({ onlyIfTrusted: true }); } catch {}
    if (window.NXWallet?.isConnected?.()) {
      try { await window.NXWallet.refreshBalance?.(true); } catch {}
      paint(window.NXWallet?.getBalance?.());
    } else {
      paint(null);
    }
  }
  window.addEventListener("nebula:sol:changed", (e)=> paint(e.detail?.balance));
  window.addEventListener("nxwallet:connected", async ()=>{
    try { await window.NXWallet.refreshBalance?.(true); } catch {}
    paint(window.NXWallet?.getBalance?.());
  });
  window.addEventListener("nxwallet:disconnected", ()=> paint(null));
});
</script>
  <style>
    :root{ --nx-cyan:#00e6ff; --nx-dark:#0a0d1b; --nx-dark-2:#12152a; --nx-border:#1e2747; --nx-text:#e0e7ff; --page-max:1200px;}
    html,body{height:100%;background:var(--nx-dark);color:var(--nx-text);font-family:'Orbitron','ui-monospace','SFMono-Regular',monospace}
    .page-wrap{max-width:var(--page-max); margin:14px auto; padding:0 12px;}
    .nx-panel{background:rgba(16,20,40,.92); border:1px solid var(--nx-border); border-radius:16px; box-shadow: inset 0 0 10px rgba(0,230,255,.18), 0 0 12px rgba(0,230,255,.08);}
    .nx-btn{ border-radius:14px; padding:.42rem .72rem; font-weight:700; transition:transform .05s ease, opacity .18s ease, box-shadow .18s ease; border:1px solid var(--nx-border); background:var(--nx-dark-2); color:var(--nx-text);}
    .nx-btn:hover{opacity:.95} .nx-btn:active{transform:translateY(1px)}
    .nx-btn-cyan{ background:var(--nx-cyan); color:#07101b; border-color:#0d3540; box-shadow:0 0 10px rgba(0,230,255,.3); }
    .tabnums{font-variant-numeric: tabular-nums;}
    .points-pill{border:1px solid var(--nx-border); background:rgba(18,22,42,.9); border-radius:9999px; padding:.25rem .6rem; font-size:12px; display:inline-flex; align-items:center; gap:.35rem}
    .points-dot{width:6px; height:6px; border-radius:50%; background:#a7f3d0; box-shadow:0 0 8px rgba(52,211,153,.6)}
    .stage{ border-radius:12px; overflow:hidden; border:1px solid var(--nx-border); background:#0b0f1f; min-height:500px; height:70vh;}
    .stage iframe{ width:100%; height:100%; border:0; display:block; }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="sticky top-0 z-[1000] isolate border-b border-[var(--nx-border)] bg-[rgba(10,13,27,0.9)] backdrop-blur-sm">
    <div class="page-wrap h-7 px-1 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <a href="NebulaX.html" class="flex items-center gap-2">
          <img src="NebulaX-logo.png" class="h-6 w-6 rounded-md" alt="NebulaX"/>
          <span class="font-bold tracking-wide" style="text-shadow:0 0 2px var(--nx-cyan);">NEBULAX</span>
        </a>
        <nav class="hidden sm:flex items-center gap-2 ml-2">
          <a class="nx-btn px-2 py-1 text-xs" href="NebulaX.html">Home</a>
          <a class="nx-btn px-2 py-1 text-xs" href="NewPairs-official.html">New Pairs</a>
          <a class="nx-btn px-2 py-1 text-xs" href="Trending.html">Trending</a>
          <a class="nx-btn px-2 py-1 text-xs" href="portfolio_official_v_2_fixed.html">Portfolio</a>
          <a class="nx-btn px-2 py-1 text-xs" href="Adrenaline-official.html">Adrenaline</a>
          <a class="nx-btn px-2 py-1 text-xs" href="nebula_x_store_official.html">Store</a>
          <a class="nx-btn nx-btn-cyan px-2 py-1 text-xs" href="NEBX-Arcade.html">Arcade</a>
        </nav>
      </div>

      <!-- Wallet + Profile + Points -->
      <div class="flex items-center gap-2">
        <div class="points-pill"><span class="points-dot"></span><span>Points:</span><strong id="xp-head" class="tabnums">0</strong></div>
        <button id="wallet-btn" class="nx-btn"><i data-lucide="wallet" class="w-3 h-3 mr-2"></i> Connect Wallet</button>
        <button id="nx-profile" class="relative w-8 h-8 rounded-xl overflow-hidden border"
                style="border-color:var(--nx-border)">
          <img id="nx-pfp" src="/pfp/default.png" alt="" class="absolute inset-0 w-full h-full object-cover" />
        </button>
      </div>
    </div>
  </header>

  <div class="page-wrap">
    <div class="grid grid-cols-1 lg:grid-cols-[1fr_300px] gap-3">
      <!-- Left: Game -->
      <section class="space-y-3">
        <div class="nx-panel p-3">
          <!-- Title + badges -->
          <div class="flex items-start justify-between">
            <div>
              <div class="text-xl font-bold" id="g-title">Game</div>
              <!-- Description moved directly under name -->
              <p id="g-desc" class="text-sm text-zinc-400 mt-1"></p>
              <div class="mt-1 flex items-center gap-2">
                <span id="g-tag" class="px-2 py-0.5 text-[11px] rounded-full border border-[var(--nx-border)] text-zinc-300"></span>
                <span class="px-2 py-0.5 text-[11px] rounded-full border border-[var(--nx-border)] text-emerald-300">NEBX Arcade</span>
              </div>
            </div>
            <div class="flex items-center gap-2">
              <div class="text-xs text-zinc-400">Turns Left:</div>
              <div class="tabnums font-bold text-amber-300" id="turns-display">0/3</div>
            </div>
          </div>

          <!-- Controls row -->
          <div class="mt-2 grid grid-cols-1 md:grid-cols-[auto_1fr_auto] items-center gap-2">
            <div class="flex items-center gap-2">
              <!-- Restart button removed - restarts happen in-game -->
            </div>
            <div class="text-xs text-zinc-400 md:justify-self-center">Session Points: <strong id="session-pts" class="tabnums">0</strong></div>
            <div class="text-xs md:justify-self-end"><span class="text-zinc-400">Wallet:</span> <span id="wallet-short" class="text-zinc-300">Guest</span></div>
          </div>

          <!-- Stage -->
          <div class="mt-2 stage" id="stage" style="position:relative;">
            <!-- game iframe injected here -->
            <!-- Overlay when out of turns -->
            <div id="no-turns-overlay" class="hidden" style="position:absolute; inset:0; background:rgba(10,13,27,0.95); z-index:10; display:none; align-items:center; justify-content:center; border-radius:12px;">
              <div class="text-center p-6">
                <div class="text-xl font-bold text-cyan-400 mb-2">Out of Turns</div>
                <div class="text-sm text-zinc-400 mb-4">Please purchase more turns to play again</div>
                <button id="purchase-from-overlay" class="nx-btn nx-btn-cyan">
                  <i data-lucide="shopping-cart" class="w-3 h-3 mr-1"></i> Buy 3 Turns • 0.010 SOL
                </button>
              </div>
            </div>
          </div>
        </div>

      </section>

      <!-- Right: Stats + Play (Play moved here under Stats) -->
      <aside class="space-y-3">
        <div class="nx-panel p-3">
          <div class="text-sm font-semibold mb-2">Your Stats</div>
          <div class="grid grid-cols-2 gap-2">
            <div class="p-2 border border-[var(--nx-border)] rounded-lg">
              <div class="text-xs text-zinc-400">Arcade Points</div>
              <div id="xp-side" class="tabnums text-lg">0</div>
            </div>
            <div class="p-2 border border-[var(--nx-border)] rounded-lg">
              <div class="text-xs text-zinc-400">Buy-in</div>
              <div class="tabnums"><span id="buyin-sol-side">0.010</span> SOL</div>
            </div>
          </div>
        </div>

        <!-- NEW: Play panel -->
        <div class="nx-panel p-3">
          <div class="text-sm font-semibold mb-2">Purchase Turns</div>
          <div class="text-xs text-zinc-400 mb-2">
            <div>Turns Remaining: <span id="turns-remaining" class="tabnums font-bold text-amber-300">0</span> / 3</div>
            <div class="mt-1">Current SOL: <span id="sol-usd-side" class="tabnums">$—</span></div>
          </div>
          <button id="btn-play" class="nx-btn nx-btn-cyan w-full">
            <i data-lucide="shopping-cart" class="w-3 h-3 mr-1"></i>
            Buy 3 Turns • <span id="buyin-sol">0.010</span> SOL (<span id="buyin-usd">$—</span>)
          </button>
          <div class="text-[11px] text-zinc-500 mt-2">Purchase 3 turns to play. Each game restart uses 1 turn. Payments disabled in demo.</div>
        </div>

        <div class="nx-panel p-3">
          <div class="text-sm font-semibold mb-2">Game Details</div>
          <ul class="text-xs text-zinc-400 space-y-1" id="g-details"></ul>
        </div>
      </aside>
    </div>
  </div>

  <script>
    if (window.lucide?.createIcons) window.lucide.createIcons();

    /* Registry of games */
    const GAMES = {
      'nebby-runner':     { name:'Nebby Runner', tag:'Arcade',   src:'games/Nebby%20Run/Nebbyrun.html', desc:'Endless runner. Dodge asteroids and rack up distance for points.', details:['Endless runner','Distance milestones award points','Use arrow keys to rotate','Space to jump/double jump'] },
      'nebby-defender':   { name:'Nebby Defender', tag:'Arcade', src:'games/Nebby%20Defender/nebby-defender.html', desc:'Tower defense style game. Protect Nebby from incoming waves.', details:['Tower defense gameplay','Survive waves of enemies','Click to shoot','Earn points for each wave'] },
      'five-minute':      { name:'5-Minute Prediction', tag:'Markets', src:'about:blank', desc:'Predict SOL\'s next 5-minute candle. Correct calls = points.', details:['Predict SOL next 5m','Correct = points (demo)'] },
      'portfolio-battle': { name:'Mock Portfolio Battle', tag:'Strategy', src:'about:blank', desc:'Grow demo SOL faster than others. Cosmetics for weekly winners.', details:['Demo SOL growth race','Weekly cosmetic rewards'] },
      'nebby-explore':     { name:'Nebby Explore', tag:'Arcade', src:'games/Nebby%20Explore/nebby-explore.html', desc:'Top-down infinite racer. Dodge traffic, asteroids, and enemy ships.', details:['Move left/right to dodge','Survive as long as possible','Earn 500 pts per second'] },
    };

    /* URL param */
    const params = new URLSearchParams(location.search);
    const slug = params.get('game') || 'nebby-runner';
    const game = GAMES[slug] || GAMES['nebby-runner'];

    // Populate title + description + badges + details
    document.getElementById('g-title').textContent = game.name;
    document.getElementById('g-desc').textContent  = game.desc || '';
    document.getElementById('g-tag').textContent   = game.tag;
    document.getElementById('g-details').innerHTML = (game.details||[]).map(d=>`<li>• ${d}</li>`).join('');

    /* Points store (same as Arcade) */
    (function(){
      const STORAGE='nebx:arcade:points';
      function key(){ try{ return (window.NX?.wallet?.getAddress?.()||'').toString() || 'guest'; }catch{ return 'guest'; } }
      function all(){ try{ return JSON.parse(localStorage.getItem(STORAGE)||'{}'); }catch{ return {}; } }
      function save(m){ try{ localStorage.setItem(STORAGE, JSON.stringify(m)); }catch{} }
      function total(){ const m=all(); return m[key()]||0; }
      function add(n){ const k=key(), m=all(); m[k]=(m[k]||0)+Math.max(0,Math.floor(n||0)); save(m); render(); }
      
      // Listen for messages from game iframe
      window.addEventListener('message',(e)=>{ 
        const d=e?.data||{}; 
        
        // Handle points
        if(d.type==='nebx:points'){ 
          add(Number(d.delta)||0); 
          document.getElementById('session-pts').textContent = String((+document.getElementById('session-pts').textContent||0) + (Number(d.delta)||0)); 
        }
        
        // Handle game restart - consume a turn
        if(d.type==='nebx:game:restart'){
          console.log('Game restart detected from iframe, origin=', e.origin);
          // Locate the iframe that sent this message by matching event source
          const iframes = document.querySelectorAll('#stage iframe');
          let srcFrame = null;
          for(const f of iframes){
            try{ if(f.contentWindow === e.source){ srcFrame = f; break; } }catch(err){}
          }

          // Always consume a turn on every restart request
          if(useTurn()){
            console.log('Turn consumed on game restart for', srcFrame?.src || srcFrame?.dataset?.gameId || srcFrame?.id, 'Remaining:', turnsRemaining);
            try{ if(srcFrame && srcFrame.contentWindow) srcFrame.contentWindow.postMessage({type:'nebx:allow:restart'}, '*'); }catch(e){}
          } else {
            console.log('No turns left - blocking restart for origin=', e.origin);
            try{ if(srcFrame && srcFrame.contentWindow) srcFrame.contentWindow.postMessage({type:'nebx:block:restart'}, '*'); }catch(e){}
          }
        }
        // Handle game-over messages from games (panel should register a turn used)
          if(typeof d.type === 'string' && d.type.endsWith(':gameover')){
            console.log('Received gameover from iframe', d, 'origin=', e.origin);
            // Find iframe that sent this message
            const iframes = document.querySelectorAll('#stage iframe');
            let srcFrame = null;
            for(const f of iframes){
              try{ if(f.contentWindow === e.source){ srcFrame = f; break; } }catch(err){}
            }
            if(srcFrame){
              // If we've already seen a gameover for this iframe, ignore duplicates
              if(srcFrame.dataset && srcFrame.dataset.gameoverSeen === '1'){
                console.log('Duplicate gameover ignored for this iframe session', srcFrame.src || srcFrame.dataset.gameId || srcFrame.id);
              } else {
                // Mark that we've seen a gameover for this iframe and reset turnConsumed so next restart will always consume a turn
                try{ srcFrame.dataset.gameoverSeen = '1'; }catch(e){}
                try{ srcFrame.dataset.turnConsumed = '0'; }catch(e){}
                // Send ack back to the game iframe so it can update UI if desired
                try{ srcFrame.contentWindow.postMessage({ type: 'nebx:panel:ack', status: 'ok', score: d.score, level: d.level }, '*'); }catch(e){}
                console.log('Gameover acknowledged for iframe (no turn consumed here, turnConsumed reset) ->', srcFrame.src || srcFrame.dataset.gameId || srcFrame.id);
              }
            }
        }
      });
      
      function render(){
        const t=total();
        document.getElementById('xp-head').textContent = t.toLocaleString();
        document.getElementById('xp-side').textContent = t.toLocaleString();
        const addr = (window.NX?.wallet?.getAddress?.()||'Guest').toString();
        document.getElementById('wallet-short').textContent = addr==='Guest' ? 'Guest' : addr.replace(/^(.{4}).*(.{4})$/,'$1…$2');
      }
      window.addEventListener('load', render);
    })();

    /* Live SOL price -> buy-in display (fallback if API fails) */
    const BUYIN_SOL = 0.010; // ~ $1–1.50 target depending on SOL price
    let SOL_USD = 211.90; // fallback value at build time
    
    /* Turn System */
    let turnsRemaining = 0;
    let turnsTotal = 3;
    
    function updateTurnsDisplay(){
      const turnsDisplay = document.getElementById('turns-display');
      const turnsRemaining_elem = document.getElementById('turns-remaining');
      const overlay = document.getElementById('no-turns-overlay');
      
      if(turnsDisplay) turnsDisplay.textContent = `${turnsRemaining}/${turnsTotal}`;
      if(turnsRemaining_elem) turnsRemaining_elem.textContent = turnsRemaining;
      
      if(overlay){
        if(turnsRemaining <= 0){
          overlay.style.display = 'flex';
          overlay.classList.remove('hidden');
        } else {
          overlay.style.display = 'none';
          overlay.classList.add('hidden');
        }
      }
    }
    
    function purchaseTurns(){
      turnsRemaining = turnsTotal;
      updateTurnsDisplay();
      loadGame(); // Load game immediately after purchase (doesn't consume a turn)
      
      // Notify game iframe that turns were purchased
      setTimeout(() => {
        const iframe = document.querySelector('#stage iframe');
        if(iframe && iframe.contentWindow){
          iframe.contentWindow.postMessage({type:'nebx:turns:purchased'}, '*');
        }
      }, 500); // Wait for iframe to load
      
      console.log('Purchased 3 turns');
    }
    
    function useTurn(){
      if(turnsRemaining > 0){
        turnsRemaining--;
        updateTurnsDisplay();
        console.log('Turn used. Remaining:', turnsRemaining);
        return true;
      }
      console.log('No turns remaining!');
      return false;
    }
    
    function updateBuyin(){
      const usd = (BUYIN_SOL * SOL_USD);
      document.getElementById('sol-usd-side').textContent = '$'+SOL_USD.toFixed(2);
      document.getElementById('buyin-sol').textContent    = BUYIN_SOL.toFixed(3);
      document.getElementById('buyin-usd').textContent    = '$'+usd.toFixed(2);
      document.getElementById('buyin-sol-side').textContent = BUYIN_SOL.toFixed(3);
    }
    updateBuyin();
    updateTurnsDisplay();
    
    fetch('https://api.coingecko.com/api/v3/simple/price?ids=solana&vs_currencies=usd',{cache:'no-store'})
      .then(r=>r.json()).then(j=>{
        const v = j?.solana?.usd;
        if(typeof v==='number' && isFinite(v)) SOL_USD = v;
      }).catch(()=>{}).finally(updateBuyin);

    /* Load game into stage */
    const stage = document.getElementById('stage');
    function loadGame(){
      if(turnsRemaining <= 0){
        console.log('No turns remaining');
        return;
      }
      
      stage.innerHTML='';
      console.log('Loading game:', game.name, 'from:', game.src);
      if(game.src && game.src!=='about:blank'){
      const f=document.createElement('iframe'); 
      f.src=game.src; 
        f.setAttribute('sandbox', 'allow-scripts allow-same-origin allow-forms');
        f.referrerPolicy='no-referrer'; 
        f.loading='eager';
        f.style.width = '100%';
        f.style.height = '100%';
        f.style.border = '0';
        f.onload = () => console.log('Game iframe loaded successfully');
        f.onerror = (e) => console.error('Game iframe error:', e);
        stage.appendChild(f);
        // mark that this iframe has not yet consumed a turn for the current session
        try{ f.dataset.turnConsumed = '0'; }catch(e){}
      }else{
        const f=document.createElement('iframe'); f.setAttribute('sandbox','allow-scripts allow-same-origin');
        const doc = `<!doctype html><meta charset="utf-8"><style>
          html,body{height:100%;margin:0;background:#0b0f1f;color:#d1e8ff;font:14px/1.4 system-ui,Segoe UI,Roboto}
          .wrap{height:100%;display:grid;place-items:center}
          .card{width:min(520px,90%);border:1px solid #1e2747;border-radius:12px;padding:16px;background:linear-gradient(180deg,#0e1426,#0a0f1f)}
          .btn{padding:10px 14px;border:1px solid #1e2747;border-radius:10px;background:#12162a;color:#d1e8ff;cursor:pointer}
          .btn:active{transform:translateY(1px)}
        </style>
        <div class="wrap"><div class="card">
          <h3 style="margin:0 0 8px 0">${game.name} (Demo)</h3>
          <p>Click to award points to parent via <code>postMessage</code>.</p>
          <button class="btn" onclick="parent.postMessage({type:'nebx:points', delta:50}, '*')">+50 Points</button>
        </div></div>`;
        stage.appendChild(f); const d=f.contentWindow.document; d.open(); d.write(doc); d.close();
        try{ f.dataset.turnConsumed = '0'; }catch(e){}
      }
    }
    
    // Don't auto-load game - wait for purchase
    // loadGame();

    // Buttons
    document.getElementById('btn-play').addEventListener('click', () => {
      purchaseTurns();
    });
    
    document.getElementById('purchase-from-overlay').addEventListener('click', () => {
      purchaseTurns();
    });
    
    // Re-create icons after any DOM updates
    if (window.lucide?.createIcons) {
      window.lucide.createIcons();
    }
  </script>
</body>
</html>
